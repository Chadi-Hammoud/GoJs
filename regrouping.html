<!DOCTYPE html>
<html lang="en">

  <body>
    <script src="https://unpkg.com/gojs@2.3.11/release/go.js"></script>
    <div id="allSampleContent" class="p-4 w-full">
      <script id="code">
      let _data = [];
      function init() {
        myDiagram = new go.Diagram("myDiagramDiv", {
          mouseDrop: e => finishDrop(e, null),

          layout: new go.GridLayout({
            wrappingWidth: Infinity,
            alignment: go.GridLayout.Position,
            cellSize: new go.Size(1, 1)
          }),
          "commandHandler.archetypeGroupData": { isGroup: true, text: "Group", horiz: false },
          "undoManager.isEnabled": true,
          "allowReshape": true,
        });



        // The one template for Groups can be configured to be either layout out its members
        // horizontally or vertically, each with a different default color.

        function makeLayout(horiz) {  // a Binding conversion function
          if (horiz) {
            return new go.GridLayout(
              {
                wrappingWidth: Infinity, alignment: go.GridLayout.Position,
                cellSize: new go.Size(1, 1), spacing: new go.Size(10, 4)
              });
          } else {
            return new go.GridLayout(
              {
                wrappingColumn: 1, alignment: go.GridLayout.Position,
                cellSize: new go.Size(1, 1), spacing: new go.Size(4, 4)
              });
          }
        }

        function defaultColor(horiz) {  // a Binding conversion function
          return horiz ? "#c7fcf6" : "rgba(51,211,229, 0.5)";
        }

        // this function is used to highlight a Group that the selection may be dropped into
        function highlightGroup(e, grp, show) {
          if (!grp) return;
          e.handled = true;
          if (show) {
            // cannot depend on the grp.diagram.selection in the case of external drag-and-drops;
            // instead depend on the DraggingTool.draggedParts or .copiedParts
            var tool = grp.diagram.toolManager.draggingTool;
            var map = tool.draggedParts || tool.copiedParts;  // this is a Map
            // now we can check to see if the Group will accept membership of the dragged Parts
            if (grp.canAddMembers(map.toKeySet())) {
              grp.isHighlighted = true;
              return;
            }
          }
          grp.isHighlighted = false;
        }


        function finishDrop(e, grp) {
          var ok;
          if (grp !== null) {
            if (grp.data.text === 'Shelf') {
              // Check if the dropped part is a port
              if (e.diagram.selection.first().data.text === 'Port') {
                // Create a new board
                var newBoardData = { key: go.UniqueId.toString(), isGroup: true, text: 'Board', horiz: false, parent: grp.data.key };
                // Add the port to this new board
                var portData = e.diagram.selection.first().data;
                // portData.parent = newBoardData.key;
                // // Add this new board to the original shelf
                // e.diagram.model.addNodeData(newBoardData);
                // e.diagram.model.addNodeData(portData);
                // ok = true;
              } else {
                // Otherwise, add the selection as members of the Group
                ok = grp.addMembers(grp.diagram.selection, true);
              }
            } else {
              // Otherwise, add the selection as members of the Group
              ok = grp.addMembers(grp.diagram.selection, true);
            }
          } else {
            // If the target is not a group, make the selection top-level
            ok = e.diagram.commandHandler.addTopLevelParts(e.diagram.selection, true);
          }
          if (!ok) e.diagram.currentTool.doCancel();
        }






        myDiagram.groupTemplate =
          new go.Group("Auto",
            {
              background: "#000",
              ungroupable: true,
              // highlight when dragging into the Group
              mouseDragEnter: (e, grp, prev) => highlightGroup(e, grp, true),
              mouseDragLeave: (e, grp, next) => highlightGroup(e, grp, true),
              computesBoundsAfterDrag: true,
              computesBoundsIncludingLocation: true,
              // when the selection is dropped into a Group, add the selected Parts into that Group;
              // if it fails, cancel the tool, rolling back any changes
              mouseDrop: finishDrop,
              handlesDragDropForMembers: true,  // don't need to define handlers on member Nodes and Links
              // Groups containing Groups lay out their members horizontally
              layout: makeLayout(false),
              mouseEnter: (e, node) => {
                var adorn = node.findAdornment("Resizing");
                if (adorn !== null) {
                  var tool = myDiagram.toolManager.resizingTool;
                  tool.handle = adorn.elt(0); // 0 for top handle
                  myDiagram.currentTool = tool; // starts the ResizingTool
                  tool.doActivate();            // activates the ResizingTool
                }
              },
            }
          )
            .bind("layout", "horiz", makeLayout)
            .bind(new go.Binding("background", "isHighlighted", h => h ? "black" : "transparent").ofObject())
            .add(new go.Shape("Rectangle",
              { fill: null, stroke: defaultColor(false), fill: defaultColor(false), strokeWidth: 2 })
              .bind("stroke", "horiz", defaultColor)
              .bind("fill", "horiz", defaultColor))


            .add(
              new go.Panel("Vertical")  // title above Placeholder
                .add(new go.Panel("Horizontal",  // button next to TextBlock
                  { stretch: go.GraphObject.Horizontal, background: defaultColor(false) })
                  .bind("background", "horiz", defaultColor)
                  .add(go.GraphObject.make("SubGraphExpanderButton", { alignment: go.Spot.Left, margin: 5 }))
                  .add(new go.TextBlock(
                    {
                      alignment: go.Spot.Right,
                      editable: true,
                      margin: 5,
                      // font: defaultFont(false),
                      opacity: 1,  // allow some color to show through
                      stroke: "black"
                    })
                    .bind("font", "horiz")
                    .bind("text", "text", null, null)) // `null` as the fourth argument makes this a two-way binding
                )  // end Horizontal Panel
                .add(new go.Placeholder({ padding: 5, alignment: go.Spot.TopLeft }))
            )  // end Vertical Panel

        // myDiagram.click = function (e) {
        //   var point = e.documentPoint;  // the point in document coordinates
        //   var part = e.subject;  // the part that the mouse was over, if any
        //   console.log("Mouse clicked at: " + point.toString());
        //   if (part) {
        //     console.log("Mouse was over: " + part.key);
        //   }
        // }



        myDiagram.nodeTemplate =
          new go.Node("Auto",
            { // dropping on a Node is the same as dropping on its containing Group, even if it's top-level
              mouseDrop: (e, node) => finishDrop(e, node.containingGroup),
              resizable: true, resizeObjectName: "SHAPE"
            })
            .add(new go.Picture(
              {
                width: 50,  // Set the width of the image here
                height: 50,  // Set the height of the image here
                margin: 0,
                name: "SHAPE",
                // maxSize: new go.Size(100.100),
                // minSize: new go.Size(10,10),
                // source: "./serial-port.svg"  // Set the path to your image here
              }).bind("source", "source", null, null))
            .add(new go.TextBlock(
              {
                margin: 7,
                editable: true,
                font: "bold 13px sans-serif",
                opacity: 0.90,
                innerHeight: 100,
                innerWidth: 100,
                name: "SHAPE",
                // maxSize: new go.Size(100.100),
                // minSize: new go.Size(10,10),
              })
            )


        // initialize the Palette and its contents
        myPalette =
          new go.Palette("myPaletteDiv",
            {
              nodeTemplateMap: myDiagram.nodeTemplateMap,
              groupTemplateMap: myDiagram.groupTemplateMap
            });

        myPalette.model = new go.GraphLinksModel([
          { isGroup: true, text: "Cabinet", horiz: true },
          { isGroup: true, text: "Shelf", horiz: false },
          { isGroup: true, text: "Board", horiz: true },
          { type: "Serial Port", text: "Port", color: "#fff", source: "./images/serial-port.svg" },
          { type: "Serial Port", text: "Port", color: "#fff", source: "./images/serial.svg" },
          { type: "Serial Port", text: "Port", color: "#fff", source: "./images/port001.svg" },
          { type: "Serial Port", text: "Port", color: "#fff", source: "./images/port001.svg" },
          { type: "Serial Port", text: "Port", color: "#fff", source: "./images/port002.svg" },
          { type: "Serial Port", text: "Port", color: "#fff", source: "./images/port003.svg" },
        ]);
      }

      function save() {
      _data.push(myDiagram.model.toJson());  
      myDiagram.isModified = false;
      downloadData(_data);
    }

    function downloadData(dataArray){
      let jsonData = JSON.stringify(dataArray, null, 2);
          // Create a Blob with the JSON data
          let blob = new Blob([jsonData], { type: "application/json" });
          // Create a link element
          let a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          // Set the file name
          a.download = "data.json";
          // Append the link to the body
          document.body.appendChild(a);
          // Trigger a click on the link to start the download
          a.click();
          // Remove the link from the DOM
          document.body.removeChild(a);
    }


      window.addEventListener('DOMContentLoaded', init);
    </script>
      <div id="sample">
        <div style="width: 100%; display: flex; justify-content: space-between">
          <div id="myPaletteDiv"
            style="width: 130px; margin-right: 2px; background-color:#00406c; border: 1px solid rgb(29, 96, 105); position: relative; cursor: auto;">
          </div>
          <div id="myDiagramDiv"
            style="flex-grow: 1; height: 500px; background-color: #00406c; border: 1px solid rgb(29, 96, 105); position: relative; cursor: auto;">
          </div>
        </div>

        <div id="buttons">
          <button id="saveModel" onclick="save()">Save</button>
          <a href="./preview.html"><button id="previewPage">Preview</button>

          </a> </div>

      </div>
    </div>
  </body>

</html>